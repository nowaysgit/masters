<template>
  <div ref="tab" class="tab">
    <p v-if="executionStatus == 0" class="title1">
      {{ timeText }}
    </p>
    <p v-else class="title2">{{ timeText }}</p>
    <p class="caption">
      {{ executionStatusText[executionStatus] }}
    </p>
    <svg
      width="92"
      height="92"
      viewBox="0 0 92 92"
      fill="none"
      xmlns="http://www.w3.org/2000/svg"
      role="progressbar"
      :style="`--value: ${percentage}`"
      src="assets/icons/Tab/clock.svg"
    >
      <path
        fill-rule="evenodd"
        clip-rule="evenodd"
        d="M92 46C92 45.7358 91.9978 45.4722 91.9933 45.2091L88.4938 45.2681L84.9943 45.3271C84.9981 45.5509 85 45.7752 85 46C85 46.2248 84.9981 46.4491 84.9943 46.6729L88.4938 46.7319L91.9933 46.7909C91.9978 46.5278 92 46.2642 92 46ZM89.6875 40.7272L91.6734 40.4901C91.6337 40.1575 91.5904 39.8259 91.5437 39.4955L89.5634 39.7758L87.5832 40.056C87.6259 40.3577 87.6654 40.6605 87.7016 40.9642L89.6875 40.7272ZM88.6326 35.0715L90.5704 34.5763C90.4873 34.2512 90.4008 33.9276 90.3108 33.6053L88.3845 34.143L86.4581 34.6807C86.5402 34.9747 86.6191 35.2701 86.6949 35.5667L88.6326 35.0715ZM88.3148 27.9295C88.4461 28.2366 88.5742 28.5454 88.699 28.8559L86.8432 29.6017L84.9875 30.3475C84.8736 30.0642 84.7568 29.7824 84.637 29.5022L86.4759 28.7158L88.3148 27.9295ZM85.5903 22.5635C85.7609 22.8511 85.9284 23.1406 86.0929 23.4321C86.1398 23.5152 86.1864 23.5985 86.2327 23.6819L83.1737 25.3825L80.1146 27.0831C79.8981 26.6936 79.6751 26.3082 79.4457 25.927L82.4447 24.1226L85.4437 22.3181C85.4928 22.3998 85.5417 22.4816 85.5903 22.5635ZM82.1884 17.5996C82.3951 17.8627 82.599 18.128 82.8001 18.3957L81.2011 19.597L79.6021 20.7983C79.4185 20.5539 79.2322 20.3115 79.0434 20.0712L80.6159 18.8354L82.1884 17.5996ZM77.4504 15.2286L78.8798 13.8298C78.6458 13.5907 78.4093 13.3542 78.1702 13.1202L76.7714 14.5496L75.3726 15.9791C75.591 16.1929 75.8071 16.409 76.0209 16.6274L77.4504 15.2286ZM73.1646 11.3841L74.4004 9.81161C74.1373 9.60488 73.872 9.40096 73.6043 9.19989L72.403 10.7989L71.2017 12.3979C71.4461 12.5815 71.6885 12.7678 71.9287 12.9566L73.1646 11.3841ZM69.4365 6.40969C69.5184 6.45831 69.6002 6.50718 69.6819 6.5563L67.8774 9.55529L66.073 12.5543C65.6918 12.3249 65.3064 12.1019 64.9169 11.8854L66.6175 8.82634L68.3181 5.76725C68.4015 5.81362 68.4848 5.86025 68.5679 5.90712C68.8594 6.07157 69.1489 6.23911 69.4365 6.40969ZM63.2842 5.5241L64.0705 3.68517C63.7634 3.55386 63.4546 3.4258 63.1441 3.30102L62.3983 5.15677L61.6525 7.01251C61.9358 7.12636 62.2176 7.24322 62.4978 7.36304L63.2842 5.5241ZM57.857 3.61554L58.3947 1.68918C58.0724 1.59923 57.7487 1.5127 57.4237 1.42963L56.9285 3.36736L56.4333 5.30509C56.7299 5.38088 57.0252 5.45983 57.3193 5.5419L57.857 3.61554ZM52.2242 2.43658L52.5045 0.45632C52.1741 0.409551 51.8425 0.366294 51.5099 0.326586L51.2728 2.31249L51.0358 4.29839C51.3395 4.33465 51.6423 4.37415 51.9439 4.41685L52.2242 2.43658ZM46.5041 0.00270512C46.5998 0.00373235 46.6954 0.00505163 46.7909 0.00666213L46.7319 3.50616L46.6729 7.00567C46.4491 7.00189 46.2248 7 46 7C45.7752 7 45.5509 7.00189 45.3271 7.00567L45.2681 3.50616L45.2091 0.0066621C45.3046 0.00505159 45.4002 0.00373231 45.4959 0.00270508C45.6637 0.000903222 45.8318 0 46 0C46.1682 0 46.3363 0.000903236 46.5041 0.00270512ZM40.7272 2.31249L40.4901 0.326586C40.1575 0.366294 39.8259 0.409552 39.4955 0.456321L39.7758 2.43658L40.056 4.41685C40.3577 4.37415 40.6605 4.33465 40.9642 4.29839L40.7272 2.31249ZM35.0715 3.36736L34.5763 1.42963C34.2512 1.5127 33.9276 1.59923 33.6053 1.68919L34.143 3.61555L34.6807 5.54191C34.9747 5.45983 35.2701 5.38088 35.5667 5.30509L35.0715 3.36736ZM29.6017 5.15677L28.8559 3.30102C28.5454 3.4258 28.2366 3.55386 27.9295 3.68517L28.7158 5.52411L29.5022 7.36304C29.7824 7.24322 30.0642 7.12637 30.3475 7.01251L29.6017 5.15677ZM23.4321 5.90712C23.5152 5.86025 23.5985 5.81362 23.6819 5.76725L25.3825 8.82634L27.0831 11.8854C26.6936 12.1019 26.3082 12.3249 25.927 12.5543L24.1226 9.55529L22.3181 6.5563C22.3998 6.50718 22.4816 6.45831 22.5635 6.40969C22.8511 6.23911 23.1406 6.07157 23.4321 5.90712ZM19.597 10.7989L18.3957 9.19989C18.128 9.40096 17.8627 9.60488 17.5996 9.81161L18.8354 11.3841L20.0712 12.9566C20.3115 12.7678 20.5539 12.5815 20.7983 12.3979L19.597 10.7989ZM15.2286 14.5496L13.8298 13.1202C13.5907 13.3542 13.3542 13.5907 13.1202 13.8298L14.5496 15.2286L15.9791 16.6274C16.1929 16.409 16.409 16.1929 16.6274 15.9791L15.2286 14.5496ZM11.3841 18.8354L9.81161 17.5996C9.60488 17.8627 9.40096 18.128 9.19989 18.3957L10.7989 19.597L12.3979 20.7983C12.5815 20.5539 12.7678 20.3115 12.9566 20.0712L11.3841 18.8354ZM6.40969 22.5635C6.23911 22.8511 6.07157 23.1406 5.90712 23.4321C5.86025 23.5152 5.81362 23.5985 5.76725 23.6819L8.82634 25.3825L11.8854 27.0831C12.1019 26.6936 12.3249 26.3082 12.5543 25.927L9.55529 24.1226L6.5563 22.3181C6.50718 22.3998 6.45831 22.4816 6.40969 22.5635ZM5.5241 28.7158L3.68517 27.9295C3.55386 28.2366 3.4258 28.5454 3.30102 28.8559L5.15677 29.6017L7.01251 30.3475C7.12636 30.0642 7.24322 29.7824 7.36304 29.5022L5.5241 28.7158ZM3.61554 34.143L1.68918 33.6053C1.59923 33.9276 1.5127 34.2513 1.42963 34.5763L3.36736 35.0715L5.30509 35.5667C5.38088 35.2701 5.45983 34.9748 5.5419 34.6807L3.61554 34.143ZM2.43658 39.7758L0.45632 39.4955C0.409551 39.8259 0.366294 40.1575 0.326586 40.4901L2.31249 40.7272L4.29839 40.9642C4.33465 40.6605 4.37415 40.3577 4.41685 40.0561L2.43658 39.7758ZM0.00270508 46.5041C0.000903222 46.3363 0 46.1682 0 46C0 45.8318 0.000903242 45.6637 0.00270512 45.4959C0.00373235 45.4002 0.00505163 45.3046 0.00666213 45.2091L3.50616 45.2681L7.00567 45.3271C7.00189 45.5509 7 45.7752 7 46C7 46.2248 7.00189 46.4491 7.00567 46.6729L3.50616 46.7319L0.0066621 46.7909C0.00505159 46.6954 0.00373231 46.5998 0.00270508 46.5041ZM2.31249 51.2728L0.326586 51.5099C0.366294 51.8425 0.409552 52.1741 0.456321 52.5045L2.43658 52.2242L4.41685 51.944C4.37415 51.6423 4.33465 51.3395 4.29839 51.0358L2.31249 51.2728ZM3.36736 56.9285L1.42963 57.4237C1.5127 57.7488 1.59923 58.0724 1.68919 58.3947L3.61555 57.857L5.54191 57.3193C5.45983 57.0253 5.38088 56.7299 5.30509 56.4333L3.36736 56.9285ZM5.15677 62.3983L3.30103 63.1441C3.4258 63.4546 3.55386 63.7634 3.68517 64.0705L5.52411 63.2842L7.36304 62.4978C7.24322 62.2176 7.12637 61.9358 7.01251 61.6525L5.15677 62.3983ZM5.90712 68.5679C5.86025 68.4848 5.81362 68.4015 5.76725 68.3181L8.82634 66.6175L11.8854 64.9169C12.1019 65.3064 12.3249 65.6918 12.5543 66.073L9.55529 67.8774L6.5563 69.6819C6.50718 69.6002 6.45831 69.5184 6.40969 69.4365C6.23911 69.1489 6.07157 68.8594 5.90712 68.5679ZM10.7989 72.403L9.19989 73.6043C9.40096 73.872 9.60488 74.1373 9.81161 74.4004L11.3841 73.1646L12.9566 71.9287C12.7678 71.6885 12.5815 71.4461 12.3979 71.2017L10.7989 72.403ZM14.5496 76.7714L13.1202 78.1702C13.3542 78.4093 13.5907 78.6458 13.8298 78.8798L15.2286 77.4504L16.6274 76.0209C16.409 75.8071 16.1929 75.591 15.9791 75.3726L14.5496 76.7714ZM18.8354 80.6159L17.5996 82.1884C17.8627 82.3951 18.128 82.599 18.3957 82.8001L19.597 81.2011L20.7983 79.6021C20.5539 79.4185 20.3115 79.2322 20.0712 79.0434L18.8354 80.6159ZM22.5635 85.5903C22.4816 85.5417 22.3998 85.4928 22.3181 85.4437L24.1226 82.4447L25.927 79.4457C26.3082 79.6751 26.6936 79.8981 27.0831 80.1146L25.3825 83.1737L23.6819 86.2327C23.5985 86.1864 23.5152 86.1398 23.4321 86.0929C23.1406 85.9284 22.8511 85.7609 22.5635 85.5903ZM28.7158 86.4759L27.9295 88.3148C28.2366 88.4461 28.5454 88.5742 28.8559 88.699L29.6017 86.8432L30.3475 84.9875C30.0642 84.8736 29.7824 84.7568 29.5022 84.637L28.7158 86.4759ZM34.143 88.3845L33.6053 90.3108C33.9276 90.4008 34.2513 90.4873 34.5763 90.5704L35.0715 88.6326L35.5667 86.6949C35.2701 86.6191 34.9748 86.5402 34.6807 86.4581L34.143 88.3845ZM39.7758 89.5634L39.4955 91.5437C39.8259 91.5904 40.1575 91.6337 40.4901 91.6734L40.7272 89.6875L40.9642 87.7016C40.6605 87.6654 40.3577 87.6259 40.0561 87.5832L39.7758 89.5634ZM46 92C46.2642 92 46.5278 91.9978 46.7909 91.9933L46.7319 88.4938L46.6729 84.9943C46.4491 84.9981 46.2248 85 46 85C45.7752 85 45.5509 84.9981 45.3271 84.9943L45.2681 88.4938L45.2091 91.9933C45.4722 91.9978 45.7358 92 46 92ZM51.2728 89.6875L51.5099 91.6734C51.8425 91.6337 52.1741 91.5904 52.5045 91.5437L52.2242 89.5634L51.944 87.5832C51.6423 87.6259 51.3395 87.6654 51.0358 87.7016L51.2728 89.6875ZM56.9285 88.6326L57.4237 90.5704C57.7488 90.4873 58.0724 90.4008 58.3947 90.3108L57.857 88.3845L57.3193 86.4581C57.0253 86.5402 56.7299 86.6191 56.4333 86.6949L56.9285 88.6326ZM62.3983 86.8432L63.1441 88.699C63.4546 88.5742 63.7634 88.4461 64.0705 88.3148L63.2842 86.4759L62.4978 84.637C62.2176 84.7568 61.9358 84.8736 61.6525 84.9875L62.3983 86.8432ZM68.5679 86.0929C68.4848 86.1398 68.4015 86.1864 68.3181 86.2327L66.6175 83.1737L64.9169 80.1146C65.3064 79.8981 65.6918 79.6751 66.073 79.4457L67.8774 82.4447L69.6819 85.4437C69.6002 85.4928 69.5184 85.5417 69.4365 85.5903C69.1489 85.7609 68.8594 85.9284 68.5679 86.0929ZM72.403 81.2011L73.6043 82.8001C73.872 82.599 74.1373 82.3951 74.4004 82.1884L73.1646 80.6159L71.9287 79.0434C71.6885 79.2322 71.4461 79.4185 71.2017 79.6021L72.403 81.2011ZM76.7714 77.4504L78.1702 78.8798C78.4093 78.6458 78.6458 78.4093 78.8798 78.1702L77.4504 76.7714L76.0209 75.3726C75.8071 75.591 75.591 75.8071 75.3726 76.0209L76.7714 77.4504ZM80.6159 73.1646L82.1884 74.4004C82.3951 74.1373 82.599 73.872 82.8001 73.6043L81.2011 72.403L79.6021 71.2017C79.4185 71.4461 79.2322 71.6885 79.0434 71.9287L80.6159 73.1646ZM85.5903 69.4365C85.5417 69.5184 85.4928 69.6002 85.4437 69.6819L82.4447 67.8774L79.4457 66.073C79.6751 65.6918 79.8981 65.3064 80.1146 64.9169L83.1737 66.6175L86.2327 68.3181C86.1864 68.4015 86.1398 68.4848 86.0929 68.5679C85.9284 68.8594 85.7609 69.1489 85.5903 69.4365ZM86.4759 63.2842L88.3148 64.0705C88.4461 63.7634 88.5742 63.4546 88.699 63.1441L86.8432 62.3983L84.9875 61.6525C84.8736 61.9358 84.7568 62.2176 84.637 62.4978L86.4759 63.2842ZM88.3845 57.857L90.3108 58.3947C90.4008 58.0724 90.4873 57.7487 90.5704 57.4237L88.6326 56.9285L86.6949 56.4333C86.6191 56.7299 86.5402 57.0252 86.4581 57.3193L88.3845 57.857ZM89.5634 52.2242L91.5437 52.5045C91.5904 52.1741 91.6337 51.8425 91.6734 51.5099L89.6875 51.2728L87.7016 51.0358C87.6654 51.3395 87.6259 51.6423 87.5832 51.9439L89.5634 52.2242Z"
        :fill="clockColor"
      />
    </svg>
  </div>
</template>

<script setup lang="ts">
import { ref, defineProps, computed, watch, onMounted } from "vue";
import { ExecutionStatus } from "@/models/Application";
import { timeFormat } from "@/units";
import { useStore } from "vuex";
import { Props } from "@/models/UI/Props";

const props = defineProps({
  time: Props.number,
});

const store = useStore();
const tab = ref();
const percentage = ref<number>(100);
const clockColor = ref("white");
const timeText = ref();
const clockTime = computed(() => store.state.application.time);
const executionStatus = computed(
  () => store.state.application?.current?.executionStatus
);

onMounted(() => {
  updateStyles(executionStatus.value);
  updatePercentage(clockTime.value);
  updateTimeText(clockTime.value);
});

watch(clockTime, async (newСlockTime) => {
  updateTimeText(newСlockTime);
  updatePercentage(newСlockTime);
});

watch(executionStatus, async (newExecutionStatus) =>
  updateStyles(newExecutionStatus)
);

const updateTimeText = (newTime) => {
  if (executionStatus.value === ExecutionStatus.wait) {
    timeText.value = timeFormat(props.time);
  }
  timeText.value = `${Math.abs(Math.round(newTime / 60))} мин`;
};

const updatePercentage = (newСlockTime) => {
  if (executionStatus.value === ExecutionStatus.started) return;
  percentage.value =
    newСlockTime.value < 0
      ? -newСlockTime / 60 / (30 / 100)
      : newСlockTime / 60 / (15 / 100);
};

const updateStyles = (newStatus: ExecutionStatus) => {
  if (newStatus === ExecutionStatus.wait) {
    clockColor.value = "white";
    tab.value.style.backgroundColor = "rgba(101, 58, 226, 1)";
  } else if (newStatus === ExecutionStatus.arrived) {
    clockColor.value = "rgba(35, 184, 73, 1)";
    tab.value.style.backgroundColor = "rgba(255, 255, 255, 0.06)";
  } else if (newStatus === ExecutionStatus.lateness) {
    clockColor.value = "white";
    tab.value.style.backgroundColor = "rgba(255, 53, 53, 1)";
  } else if (newStatus === ExecutionStatus.started) {
    clockColor.value = "white";
    tab.value.style.backgroundColor = "rgba(0, 117, 255, 1)";
    percentage.value = 100;
  }
};

const executionStatusText = ["время", "до заявки", "опоздание", "в работе"];
</script>

<style lang="scss" scoped>
@import "@/styles/fonts";
@import "@/styles/colors";
@import "@/styles/Tabs";
.tab {
  @extend %tab;
  min-height: 110px;
  padding: 10px 10px;
  flex-direction: column;
  background-origin: content-box !important;
  background-size: contain !important;
  justify-content: center;

  @media (max-width: 340px) {
    min-width: calc(100vw - 232px) !important;
  }
  @media (min-width: 341px) {
    min-width: 112px !important;
  }

  @property --pgPercentage {
    syntax: "<number>";
    inherits: false;
    initial-value: 0;
  }
  svg[role="progressbar"] {
    --size: 92px;
    --fg: #369;
    --bg: rgba(44, 44, 46, 0);
    --pgPercentage: var(--value);
    width: var(--size);
    height: var(--size);
    border-radius: 50%;
    display: grid;
    position: absolute;
    z-index: 1;
    place-items: center;
    mask-image: radial-gradient(
        closest-side,
        rgba(44, 44, 46) 80%,
        transparent 0 100%,
        white 0
      ),
      conic-gradient(var(--fg) calc(var(--pgPercentage) * 1%), var(--bg) 0);
    font-family: Helvetica, Arial, sans-serif;
    font-size: calc(var(--size) / 5);
    color: var(--fg);
  }
}
.tab:before {
  content: " ";
  display: block;
  position: absolute;
  width: 92px;
  height: 92px;
  opacity: 0.32;
  background-image: url("@/assets/icons/Tab/clock.svg");
  background-repeat: no-repeat;
  background-origin: content-box !important;
  background-size: contain !important;
}
.title2 {
  @extend %title2;
  text-align: center;
  z-index: 2;
}
.title1 {
  @extend %title1;
  text-align: center;
  z-index: 2;
}
.caption {
  @extend %caption;
  text-align: center;
  z-index: 2;
}
</style>
